<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="UTF-8">
	<title>Programmazione RAI</title>
	<meta name="author" content="Giorgio Bonvicini">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="http://fonts.googleapis.com/icon?family=Material+Icons">
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/css/materialize.min.css">
    <link type="text/css" rel="stylesheet" href="wallList.css">

    <script src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/js/materialize.min.js"></script>
    <script src="colorThief.js"></script>
</head>
<body>

<script>
// Recupera tutte le informazioni su tutti iprogrammi in onda un certo giorno su un certo canale.
function getChannelData(ch, data)
{
    var baseUrl = "http://www.rai.it/dl/portale/html/palinsesti/guidatv/static/";
    var fetchUrl = baseUrl + ch + "_" + data + ".html";

    var colorPalettes =
    {
        RaiUno:
        {
            main: "#0056A5",
            border: "#003b72"
        }
    };

    var channelData = {raw: "", list: []};

    var colorThief = new ColorThief();

    jQuery.ajax({
        url: fetchUrl,
        success: function(html)
            {
                channelData.raw = html;
                var extHTML = $(html);
                
                // Primo programma fake (necessario per contare la durata).
                prg = new Object();
                prg.ora = "06:00";
                prg.titolo = "Start";
                channelData.list.push(prg);
                
                $.each($(".intG", extHTML), function(n, val)
                {
                    val = $(val);
                    prg = new Object();
                    prg.ora = $(".ora", val).html();
                    prg.link = $(".info a", val).attr("href");
                    prg.titolo = $(".info a", val).html();
                    prg.id = $(".info a", val).attr("idprogramma");
                    prg.genere = $("div.eventDescription", val).attr("data-genere");
                    prg.macrogenere = $("div.eventDescription", val).attr("data-macrogenere");
                    prg.immagine = $("div.eventDescription", val).attr("data-immagine");
                    prg.immagine = prg.immagine == "" ? "img/" + ch + "_100.jpg" : prg.immagine;
                    
                    // La durata serve per dare la lunghezza delle barre.
                    var lastPrg = channelData.list[channelData.list.length - 1];
                    lastPrg.durata = getDiff(lastPrg.ora, prg.ora);
                    // Possono comparire programmi dupicati per errore.
                    if (lastPrg.durata == 0)
                    {
                        // Rimuovi il vecchio.
                        channelData.list.pop();
                    }
                    
                    channelData.list.push(prg);
                });
                
                channelData.list.push(prg);
                
                //DEBUG
                console.log(channelData);
            },
        async: false
    });
    return channelData;
}

function getDiff(oraPrima, oraDopo) {
    // Converti le ore in minuti.
    oraPrima = (parseInt(oraPrima[0]) * 10 + parseInt(oraPrima[1])) * 60 + parseInt(oraPrima[3]) * 10 + parseInt(oraPrima[4]);
    oraDopo = (parseInt(oraDopo[0]) * 10 + parseInt(oraDopo[1])) * 60 + parseInt(oraDopo[3]) * 10 + parseInt(oraDopo[4]);
    if (oraDopo >= oraPrima)
    {
        // Ore regolari.
        return oraDopo - oraPrima;
    }
    else
    {
        console.log(oraPrima + " - " + oraDopo);
        // A cavallo della mezzanotte.
        return (24*60 - oraPrima + oraDopo);
    }
} 
</script>


<div class="container">

<!-- WallList -->
<div id="wall-container">
    
</div>

<div id="test">
</div>


<script>
var em_min = 0.8; // Ogni minuto di trasmissione corrisponde a tot em di larghezza.
var channels = ["RaiUno", "RaiDue", "RaiTre", "Rai4" ,"Extra"];
for (ch of channels)
{
    $("#wall-container").append('<div class="wall-ch" data-ch="' + ch + '"></div>');
    var chData = getChannelData(ch, "2016_02_05");
    for (var i = 1; i < chData.list.length; i = i + 1)
    {
        var prg = chData.list[i];
        
        var divImg = $('<div class="wall-prg-img"></div>').append('<img src="' + prg.immagine + '">');
        var link = ! prg.link in window ? prg.link.replace("http://", "") : "";
        var titolo = '<span class="titolo"><a href="http://' + link + '" target="_blank">' + prg.titolo + '</a></span>';
        
        var genere = "";
        if (prg.macrogenere != "" && prg.genere != "")
        {
            if (prg.macrogenere != prg.genere)
            {
                genere = prg.macrogenere + " - " + prg.genere;
            }
            else 
            {
                genere = prg.genere;
            }
        }
        else if (prg.macrogenere != "")
        {
            genere = prg.macrogenere;
        }
        else if (prg.genere != "")
        {
            genere = prg.genere;
        }
        if(genere != "")
        {
            genere = '<span class="genere">' + genere + '</span>';
        }
        
        var ora = '<span class="ora">' + prg.ora + '</span>';
        
        var divContent = $('<div class="wall-prg-content"></div>').append(titolo).append("<br>").append(genere).append("<br>").append(ora);
        
        var prgDiv = $('<div class="wall-prg card z-depth-3" style="width:' + parseFloat(prg.durata) * em_min + 'em;"></div>').append(divImg).append(divContent);
        
        $('.wall-ch[data-ch="' + ch + '"]').append(prgDiv);
    }
}

console.log(getDiff("12:45", "13:10"));
</script>


</div>
</body>
</html>
